datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  email                     String?         @unique
  username                  String?         @unique

  paymentProcessorUserId    String?         @unique
  lemonSqueezyCustomerPortalUrl String?     // You can delete this if you're not using Lemon Squeezy as your payments processor.
  subscriptionStatus        String?         // 'active', 'cancel_at_period_end', 'past_due', 'deleted'
  subscriptionPlan          String?         // 'hobby', 'pro'
  datePaid                  DateTime?
  credits                   Int             @default(0)
  videoCredits              Int             @default(0)  // Credits for video generation

  gptResponses              GptResponse[]
  contactFormMessages       ContactFormMessage[]
  tasks                     Task[]
  files                     File[]
  videoGenerations          VideoGeneration[]
}

model GptResponse {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  content                   String
}

model Task {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  description               String
  time                      String          @default("1")
  isDone                    Boolean         @default(false)
}

model File {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  name                      String
  type                      String
  key                       String
  uploadUrl                 String
}


model ContactFormMessage {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  content                   String
  isRead                    Boolean         @default(false)
  repliedAt                 DateTime?
}

enum VideoStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum Stage1Mode {
  EASY
  ADVANCED
}

enum Veo3Mode {
  FAST
  STANDARD
}

enum AssetType {
  PERSON
  COMPOSITE
  VIDEO
  FULL_PIPELINE  // For legacy wizard-generated videos
}

model VideoGeneration {
  id                    String      @id @default(uuid())
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  user                  User        @relation(fields: [userId], references: [id])
  userId                String

  // === Asset Type (for tab-based architecture) ===
  assetType             AssetType   @default(FULL_PIPELINE) // PERSON, COMPOSITE, VIDEO, or FULL_PIPELINE

  // === STAGE 1: Person Generation ===
  stage1Mode            Stage1Mode? // EASY (form fields) or ADVANCED (custom prompt)

  // Easy Mode Fields
  personGender          String?     // "male", "female", "non-binary"
  personAge             String?     // "18-25", "26-35", "36-45", "46-60", "60+"
  personEthnicity       String?     // "Caucasian", "African", "Asian", "Hispanic", etc.
  personClothing        String?     // "casual", "business", "athletic", etc.
  personExpression      String?     // "smiling", "neutral", "excited", etc.
  personBackground      String?     // "white", "outdoor", "home", etc.

  // Advanced Mode Field
  personPrompt          String?     // Custom prompt for advanced users

  // Stage 1 Output
  generatedPersonUrl    String?     // Seedream generated person image (S3 URL)

  // === STAGE 2: Compositing ===
  productImageUrl       String?     // Product image uploaded by user (S3 URL)
  compositePrompt       String?     // Instructions for how to composite product with person
  compositeImageUrl     String?     // Seedream composite output (S3 URL)

  // === STAGE 3: Video Generation ===
  videoPrompt           String?     // Prompt for video animation
  veo3Mode              Veo3Mode?   // FAST (2-3 min) or STANDARD (4-6 min)
  finalVideoUrl         String?     // Final Veo3 video (S3 URL)
  videoThumbnailUrl     String?     // Video thumbnail

  // Provider Tracking
  videoProvider         String?     // "kie" or "fal" - which provider generated the video
  fallbackUsed          Boolean     @default(false) // Whether fallback was triggered

  // === Status Tracking ===
  status                VideoStatus @default(PENDING)
  currentStage          Int         @default(1)     // 1, 2, or 3
  progress              Int         @default(0)     // 0-100

  // Stage-specific errors
  stage1Error           String?
  stage2Error           String?
  stage3Error           String?

  // Error handling metadata
  errorType             String?     // "USER_ERROR", "SYSTEM_ERROR", "SERVICE_ERROR", "TIMEOUT"
  errorMessage          String?     // User-friendly error message
  isRefundable          Boolean     @default(false) // Whether credits can be refunded
  creditsRefunded       Boolean     @default(false) // Whether credits were already refunded
  canRetry              Boolean     @default(true)  // Whether user can retry this generation

  // === Fixed Parameters ===
  duration              Int         @default(8)     // Always 8 seconds
  aspectRatio           String      @default("9:16") // Portrait

  // === Metadata ===
  fileSize              Int?        // bytes
  s3KeyPerson           String?     // S3 key for person image
  s3KeyComposite        String?     // S3 key for composite image
  s3KeyVideo            String?     // S3 key for final video

  // Legacy fields (deprecated, keeping for backward compatibility)
  referenceImageUrl     String?     // Old field - to be removed after migration
  content               String?     // Old field - to be removed after migration
  generatedImageUrl     String?     // Old field - to be removed after migration
  s3Key                 String?     // Old field - to be removed after migration
  n8nExecutionId        String?     // Old n8n workflow ID - to be removed
  thumbnailUrl          String?     // Old thumbnail field - replaced by videoThumbnailUrl

  @@index([userId, createdAt])
  @@index([userId, status])
  @@index([userId, assetType, createdAt])  // For library filtering
}
